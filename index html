<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Semakan Headcount Murid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background-color: white; }
            .card { box-shadow: none !important; border: 1px solid #e2e8f0 !important; }
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 min-h-screen">

    <!-- Navbar -->
    <nav class="bg-blue-800 text-white p-4 shadow-lg no-print">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 font-bold text-lg">
                <i data-lucide="graduation-cap"></i>
                <span class="uppercase tracking-tight">Portal Semakan Headcount</span>
            </div>
            <div class="text-xs bg-blue-700 px-3 py-1.5 rounded-lg flex items-center gap-2">
                <i data-lucide="calendar" class="w-4 h-4"></i>
                <span>Sesi 2025/2026</span>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 md:p-8">
        
        <!-- Header -->
        <header class="text-center mb-10 no-print">
            <h1 class="text-3xl md:text-4xl font-black text-slate-800 uppercase tracking-tighter">Semakan Prestasi Murid</h1>
            <p class="text-slate-500 font-medium">Sila masukkan No. Kad Pengenalan untuk melihat analisis headcount</p>
        </header>

        <!-- Search Box -->
        <div class="bg-white p-6 md:p-10 rounded-2xl shadow-xl border-t-4 border-blue-600 mb-8 no-print">
            <div class="max-w-2xl mx-auto">
                <label class="block text-center text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-4">
                    No. Kad Pengenalan (Tanpa Sempang)
                </label>
                <div class="flex flex-col md:flex-row gap-3">
                    <div class="relative flex-1">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                        <input type="text" id="icInput" placeholder="Contoh: 090102030405" 
                            class="w-full pl-12 pr-4 py-4 rounded-xl border border-slate-200 focus:ring-4 focus:ring-blue-100 focus:border-blue-600 outline-none transition text-lg">
                    </div>
                    <button id="searchBtn" class="bg-blue-700 hover:bg-blue-800 text-white font-bold px-8 py-4 rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2 min-w-[140px]">
                        <span id="btnText">SEMAK</span>
                        <i id="btnIcon" data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                </div>
                <p id="dataStatus" class="mt-4 text-center text-[10px] text-slate-400 font-medium uppercase tracking-widest">
                    Menghubungkan ke Pangkalan Data Drive...
                </p>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorMessage" class="hidden bg-red-50 border border-red-100 text-red-600 p-6 rounded-xl text-center mb-8 flex flex-col items-center gap-2">
            <i data-lucide="alert-circle" class="w-8 h-8"></i>
            <p id="errorText" class="font-bold"></p>
        </div>

        <!-- Results Display -->
        <div id="resultsArea" class="hidden space-y-6">
            <!-- Profil Murid -->
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-md border-l-8 border-blue-600">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <span class="text-[10px] font-black text-blue-500 uppercase tracking-widest">Nama Penuh Murid</span>
                        <h2 id="resNama" class="text-2xl md:text-3xl font-bold text-slate-800 uppercase"></h2>
                    </div>
                    <div>
                        <span class="text-[10px] font-black text-blue-500 uppercase tracking-widest">Sekolah & Kelas</span>
                        <p id="resSekolah" class="text-lg font-semibold text-slate-600 uppercase"></p>
                    </div>
                </div>
                <div class="mt-6 flex gap-4 no-print">
                    <button onclick="window.print()" class="flex items-center gap-2 text-sm font-bold bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg transition">
                        <i data-lucide="printer" class="w-4 h-4"></i> CETAK HEADCOUNT MURID
                    </button>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-2xl shadow-md overflow-hidden border border-slate-100">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-800 text-white text-center">
                            <tr>
                                <th class="px-6 py-4 text-left uppercase tracking-tighter">Mata Pelajaran</th>
                                <th class="px-3 py-4">TOV</th>
                                <th class="px-3 py-4">OTR 1</th>
                                <th class="px-3 py-4">OTR 2</th>
                                <th class="px-3 py-4 bg-blue-900 border-x border-blue-800">ETR</th>
                                <th class="px-3 py-4">BEZA</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-100">
                            <!-- Data rows injected here -->
                        </tbody>
                    </table>
                </div>

                <!-- Glossary Footer -->
                <div class="p-6 bg-slate-50 border-t border-slate-100">
                    <div class="flex items-start gap-4">
                        <div class="p-2 bg-blue-100 text-blue-700 rounded-lg">
                            <i data-lucide="info" class="w-5 h-5"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-slate-800 text-sm uppercase tracking-wide mb-3">Glosari Istilah Analisis</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-xs">
                                <div class="bg-white p-2 rounded border border-slate-200">
                                    <span class="font-bold text-blue-700 block">TOV</span>
                                    <span class="text-slate-500">PAT Tingkatan 4</span>
                                </div>
                                <div class="bg-white p-2 rounded border border-slate-200">
                                    <span class="font-bold text-blue-700 block">OTR 1</span>
                                    <span class="text-slate-500">PPT Tingkatan 5</span>
                                </div>
                                <div class="bg-white p-2 rounded border border-slate-200">
                                    <span class="font-bold text-blue-700 block">OTR 2</span>
                                    <span class="text-slate-500">Percubaan SPM</span>
                                </div>
                                <div class="bg-white p-2 rounded border border-slate-200">
                                    <span class="font-bold text-blue-700 block">ETR</span>
                                    <span class="text-slate-500">Sasaran SPM 2026</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center p-10 text-slate-400 text-[10px] uppercase tracking-[0.3em] no-print">
        &copy; 2026 Portal Analisis Prestasi Akademik
    </footer>

    <script>
        // Initialization
        lucide.createIcons();
        
        // Pautan fail CSV (Export direct link for Google Drive)
        const FILE_ID = "1eVDBVjNKIPWa9CR8cwWj5zh0zcH2vLKc";
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${FILE_ID}/export?format=csv`;

        let masterData = [];
        const icInput = document.getElementById('icInput');
        const searchBtn = document.getElementById('searchBtn');
        const resultsArea = document.getElementById('resultsArea');
        const statusText = document.getElementById('dataStatus');

        // Pre-fetch data to memory for instant search
        async function loadDatabase() {
            try {
                statusText.innerText = "Memuat turun data dari Drive...";
                
                Papa.parse(CSV_URL, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        masterData = results.data.map(row => {
                            // Normalize IC numbers by removing dashes
                            const rawIc = row['No. KP'] || "";
                            return { ...row, cleanIc: rawIc.replace(/-/g, '').trim() };
                        });
                        statusText.innerText = "Sistem Sedia: Data Berjaya Dihubungkan";
                        statusText.classList.replace('text-slate-400', 'text-green-600');
                    },
                    error: function(err) {
                        console.error("CSV Load Error:", err);
                        statusText.innerText = "Ralat: Gagal mencapai data Drive";
                        statusText.classList.replace('text-slate-400', 'text-red-600');
                    }
                });
            } catch (e) {
                console.error(e);
            }
        }

        loadDatabase();

        // Search Handlers
        searchBtn.addEventListener('click', doSearch);
        icInput.addEventListener('keypress', (e) => e.key === 'Enter' && doSearch());

        function doSearch() {
            const queryIc = icInput.value.replace(/-/g, '').trim();
            if (!queryIc) return;

            hideError();
            resultsArea.classList.add('hidden');
            setLoading(true);

            setTimeout(() => {
                const matches = masterData.filter(m => m.cleanIc === queryIc);

                if (matches.length > 0) {
                    renderResults(matches);
                } else {
                    showError(`No. KP ${queryIc} tidak dijumpai. Sila pastikan data anda telah didaftarkan.`);
                }
                setLoading(false);
            }, 500);
        }

        function renderResults(data) {
            document.getElementById('resNama').innerText = data[0]['Nama Murid'];
            document.getElementById('resSekolah').innerText = `${data[0]['Kelas '] || '-'} | ${data[0]['Kod | Sekolah']}`;
            
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition text-center font-medium";
                tr.innerHTML = `
                    <td class="px-6 py-4 font-bold text-slate-800 text-left border-l-4 border-transparent hover:border-blue-600">${item.MP}</td>
                    <td class="px-3 py-4">
                        <div class="text-slate-700">${item.TOV}</div>
                        <span class="text-[9px] px-2 py-0.5 rounded-full border ${getGradeColor(item.GTOV)}">${item.GTOV}</span>
                    </td>
                    <td class="px-3 py-4">
                        <div class="text-slate-700">${item['OTR 1']}</div>
                        <span class="text-[9px] px-2 py-0.5 rounded-full border ${getGradeColor(item['G OTR1'])}">${item['G OTR1']}</span>
                    </td>
                    <td class="px-3 py-4">
                        <div class="text-slate-700">${item['OTR 2']}</div>
                        <span class="text-[9px] px-2 py-0.5 rounded-full border ${getGradeColor(item['G OTR 2'])}">${item['G OTR 2']}</span>
                    </td>
                    <td class="px-3 py-4 bg-blue-50 font-bold border-x border-blue-100">
                        <div class="text-blue-900">${item.ETR}</div>
                        <span class="text-[9px] px-2 py-0.5 rounded-full border ${getGradeColor(item['G ETR'])}">${item['G ETR']}</span>
                    </td>
                    <td class="px-3 py-4 font-bold text-slate-500">${item['TOV-ETR']}</td>
                `;
                tbody.appendChild(tr);
            });

            resultsArea.classList.remove('hidden');
            resultsArea.scrollIntoView({ behavior: 'smooth' });
        }

        function getGradeColor(g) {
            if (!g) return 'bg-gray-50 border-gray-200';
            g = g.toString().toUpperCase();
            if (g.startsWith('A')) return 'bg-green-50 text-green-700 border-green-200';
            if (g.startsWith('B')) return 'bg-blue-50 text-blue-700 border-blue-200';
            if (g.startsWith('C')) return 'bg-yellow-50 text-yellow-700 border-yellow-200';
            if (g.startsWith('D')) return 'bg-orange-50 text-orange-700 border-orange-200';
            if (g.startsWith('E')) return 'bg-pink-50 text-pink-700 border-pink-200';
            if (g.startsWith('G')) return 'bg-red-50 text-red-700 border-red-200';
            return 'bg-gray-50 border-gray-200';
        }

        function setLoading(l) {
            searchBtn.disabled = l;
            document.getElementById('btnText').innerText = l ? "MENCARI..." : "SEMAK";
            document.getElementById('btnIcon').className = l ? "hidden" : "w-5 h-5";
        }

        function showError(msg) {
            document.getElementById('errorText').innerText = msg;
            document.getElementById('errorMessage').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }
    </script>
</body>
</html>
